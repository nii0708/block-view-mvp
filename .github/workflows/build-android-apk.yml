name: Build Android APK & AAB (Local)
on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“± Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm
          
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          
      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: ðŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps
        
      - name: ðŸ— Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          
      - name: ðŸ”§ Accept Android SDK licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        
      - name: ðŸ“± Install required Android components
        run: |
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "platform-tools" \
            "cmdline-tools;latest"
            
      # Debug environment variables
      - name: ðŸ” Debug Environment Variables
        run: |
          echo "ðŸ” Node version: $(node --version)"
          echo "ðŸ” NPM version: $(npm --version)"
          echo "ðŸ” EAS CLI version: $(eas --version)"
          echo "ðŸ” Build type: ${{ github.event.inputs.build_type || 'both' }}"
          echo "ðŸ” Environment check completed"
          
      # Build APK
      - name: ðŸš€ Build APK (Local)
        if: github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
        run: |
          echo "ðŸš€ Starting local APK build at $(date)"
          echo "ðŸ“‹ Using EAS Environment Variables for Supabase config"
          
          # Build APK with clear cache
          eas build --local \
            --platform android \
            --profile preview \
            --output mine.lite.apk \
            --non-interactive \
            --clear-cache
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          
      # Build AAB (Android App Bundle)
      - name: ðŸŽ¯ Build AAB (Local)
        if: github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
        run: |
          echo "ðŸŽ¯ Starting local AAB build at $(date)"
          echo "ðŸ“‹ Building Android App Bundle for Google Play Store"
          
          # Build AAB with clear cache
          eas build --local \
            --platform android \
            --profile production \
            --output mine.lite.aab \
            --non-interactive \
            --clear-cache
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          
      # Upload APK as GitHub Artifact
      - name: ðŸ“¤ Upload APK as GitHub Artifact
        if: success() && (github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '') && hashFiles('mine.lite.apk') != ''
        uses: actions/upload-artifact@v4
        with:
          name: mine-lite-apk-${{ github.run_number }}
          path: mine.lite.apk
          retention-days: 30
          
      # Upload AAB as GitHub Artifact
      - name: ðŸ“¦ Upload AAB as GitHub Artifact
        if: success() && (github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '') && hashFiles('mine.lite.aab') != ''
        uses: actions/upload-artifact@v4
        with:
          name: mine-lite-aab-${{ github.run_number }}
          path: mine.lite.aab
          retention-days: 30
          

          
      # Create comprehensive build summary
      - name: ðŸ“ Create build summary
        if: success()
        run: |
          echo "## ðŸš€ Android Build Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # APK Summary
          if [ -f "mine.lite.apk" ]; then
            APK_SIZE=$(du -h mine.lite.apk | cut -f1)
            echo "### ðŸ“± APK Build" >> $GITHUB_STEP_SUMMARY
            echo "- **File:** mine.lite.apk" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Profile:** preview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # AAB Summary
          if [ -f "mine.lite.aab" ]; then
            AAB_SIZE=$(du -h mine.lite.aab | cut -f1)
            echo "### ðŸ“¦ AAB Build (Google Play)" >> $GITHUB_STEP_SUMMARY
            echo "- **File:** mine.lite.aab" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $AAB_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Profile:** production" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
